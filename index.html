<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>For CSDI use</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
    <link
      href="https://api.tiles.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Inter"
      rel="stylesheet"
    />
    <style>
      body {margin: 0; padding: 0;}
      #map {position: absolute; top: 0; bottom: 0; width: 100%;}
      .box {line-height: 0.9;}
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div class="map-overlay top">
        <div class="map-overlay-inner">
            <h2>Distance covered in minutes</h2>
            <label id="maxMinutes"></label>
            <input id="slider" type="range" min="0" max="30" step="3" value="15">
        </div>
        <div class="map-overlay-inner">
            <div id="legend" class="legend">
                <div class="bar"></div>
                <div>Magnitude (m)</div>
            </div>
        </div>
        <div id='tab-bar'></div>
    </div>
    <script>
      mapboxgl.accessToken = "pk.eyJ1IjoibmV3aXNsYW5kMTIyMyIsImEiOiJjamJqaG5jb3Y0MHVpMnFxZ3IzN3NhbGwzIn0.giv88MrlUsX2WznylrLvwA";
      const map = new mapboxgl.Map({
        container: "map",
        style: "mapbox://styles/newisland1223/clzig8nrs00l501qqa3yxfgzm",
        center: [114.141, 22.495], // Fanling
        zoom: 13.4
      });
      const locations = [
        { name: 'Cheung Lung Wai Estate', coords: [114.12350000000004, 22.49490000000003] },
        { name: 'Ching Ho Estate', coords: [114.12580000000004, 22.493100000000027] },
        { name: 'Choi Yuen Estate', coords: [114.12580000000004, 22.501700000000028] },
        { name: 'Fai Ming Estate', coords: [114.13610000000006, 22.481100000000023] },
        { name: 'Ka Fuk Estate', coords: [114.13490000000002, 22.49270000000007] },
        { name: 'Po Shek Wu Estate', coords: [114.12430000000006, 22.503300000000024] },
        { name: 'Wah Sum Estate', coords: [114.14320000000008, 22.48580000000004] },
        { name: 'Grandeur Terrace', coords: [114.00240000000008, 22.468800000000044] },
        { name: 'Long Ching Estate', coords: [114.0286000000001, 22.44650000000007] },
        { name: 'Shui Pin Wai Estate', coords: [114.02030000000002, 22.446000000000023] },
        { name: 'Tin Chak Estate', coords: [113.99750000000006, 22.467300000000023] },
        { name: 'Tin Ching Estate', coords: [114.00350000000005, 22.462900000000047] },
        { name: 'Tin Heng Estate', coords: [113.99890000000003, 22.470600000000047] },
        { name: 'Tin Shui (I) Estate, Tin Shui (II) Estate', coords: [113.99868400000004, 22.455341000000036] },
        { name: 'Tin Tsz Estate', coords: [114.00740000000008, 22.452600000000075] },
        { name: 'Tin Wah Estate', coords: [113.9955000000001, 22.46070000000003] },
        { name: 'Tin Yan Estate', coords: [113.9960000000001, 22.46440000000007] },
        { name: 'Tin Yat Estate', coords: [114.00020000000006, 22.46670000000006] },
        { name: 'Tin Yiu (I) Estate, Tin Yiu (II) Estate', coords: [114.00462300000004, 22.451112000000023] },
        { name: 'Tin Yuet Estate', coords: [113.99940000000004, 22.46270000000004] },
        { name: 'Long Ping Estate', coords: [114.02280000000007, 22.449100000000044] },
        { name: 'Cheung Wah Estate', coords: [114.14190000000008, 22.492200000000025] },
        { name: 'Tai Ping Estate', coords: [114.12670000000004, 22.498000000000047] },
        { name: 'Tin Ping Estate', coords: [114.1323000000001, 22.50350000000003] },
        { name: 'Wah Ming Estate', coords: [114.14020000000004, 22.484500000000025] },
        { name: 'Cheong Shing Court', coords: [114.1382000000001, 22.483900000000062] },
        { name: 'Choi Po Court', coords: [114.12430000000006, 22.501100000000065] },
        { name: 'Ka Shing Court', coords: [114.1341000000001, 22.49380000000008] },
        { name: 'King Shing Court', coords: [114.1409000000001, 22.487700000000075] },
        { name: 'On Shing Court', coords: [114.13520000000004, 22.502200000000077] },
        { name: 'Sunningdale Garden', coords: [114.13210000000004, 22.501600000000053] },
        { name: 'Tsui Lai Garden', coords: [114.12830000000008, 22.50830000000008] },
        { name: 'Wing Fai Centre', coords: [114.14320000000008, 22.501600000000053] },
        { name: 'Wing Fok Centre', coords: [114.14040000000011, 22.50130000000007] },
        { name: 'Yan Shing Court', coords: [114.13920000000007, 22.48720000000003] },
        { name: 'Yuk Po Court', coords: [114.12830000000008, 22.499900000000025] },
        { name: 'Yung Shing Court', coords: [114.13800000000003, 22.48280000000005] },
        { name: 'Fung Ting Court', coords: [114.0322000000001, 22.443100000000072] },
        { name: 'Ping Yan Court', coords: [114.00350000000005, 22.44560000000007] },
        { name: 'Tin Chung Court', coords: [114.00030000000004, 22.46070000000003] },
        { name: 'Tin Fu Court', coords: [113.99940000000004, 22.465100000000064] },
        { name: 'Tin Lai Court', coords: [114.00800000000004, 22.452900000000056] },
        { name: 'Tin Oi Court', coords: [113.99790000000009, 22.454000000000065] },
        { name: 'Tin Shing Court', coords: [114.00220000000002, 22.447500000000048] },
        { name: 'Tin Yau Court', coords: [114.00610000000006, 22.451900000000023] },
        { name: 'Wang Fu Court', coords: [114.02820000000008, 22.450800000000072] },
        { name: 'Ching Tao Court', coords: [114.12880000000008, 22.495300000000043] },
        { name: 'North District Park', coords: [114.1341113, 22.49892247] },
        { name: 'The park located east of Fan Kam Road', coords: [114.122099, 22.49502554] },
        { name: 'Tin Tsz Garden', coords: [114.00853, 22.4520446] },
        { name: 'Fung Cheung Road Garden', coords: [114.0326723, 22.44439963] },
        { name: 'Tin Ping Road Garden', coords: [114.1267913, 22.50931355] },
        { name: 'Tai Tau Leng Sitting-out Area', coords: [114.1232912, 22.50028734] },
        { name: 'Yat Ming Road Park', coords: [114.1448732, 22.48556901] },
        { name: 'San Wan Road Sitting-out Area', coords: [114.1364068, 22.49518487] },
        { name: 'Tin Yip Road Park', coords: [114.0074497, 22.46323409] },
        { name: 'Tin Shui Wai Park', coords: [114.0034542, 22.45565875] }
      ];

      const modeOfTravel = 'walking'
      const chosenMinutes = [5, 10, 15]
      
      async function getIsochrone(lon, lat, profile = modeOfTravel, minutes = chosenMinutes) {
        const urlBase = 'https://api.mapbox.com/isochrone/v1/mapbox/';
        const query = await fetch(
            `${urlBase}${profile}/${lon},${lat}?contours_minutes=${minutes.join(',')}&polygons=true&access_token=${mapboxgl.accessToken}`,
            { method: 'GET' }
        );
        return await query.json();
      }
      map.on('load', async () => {
          // Colors for different locations
          const colorForOpenSpace = '#3FB1CE';
      
          // Loop through locations
          for (let i = 0; i < locations.length; i++) {
              const loc = locations[i];
              const data = await getIsochrone(loc.coords[0], loc.coords[1], modeOfTravel, chosenMinutes);
      
              // Add GeoJSON source
              map.addSource(`iso-${loc.name}`, {
                  type: 'geojson',
                  data: data
              });
      
              // Add fill layer for isochrones
              map.addLayer({
                  id: `isoLayer-${loc.name}`,
                  type: 'fill',
                  source: `iso-${loc.name}`,
                  layout: {},
                  paint: {
                      'fill-color': colorForOpenSpace,
                      'fill-opacity': 0.1 // Transparency to see overlaps
                  }
              });
      
              // Add marker for the location
              new mapboxgl.Marker({
                scale: 0.5
              })
                  .setLngLat(loc.coords)
                  .addTo(map);

              // Add hover events
              const markerElement = marker.getElement();
              markerElement.style.cursor = 'pointer';
              markerElement.addEventListener('mouseover', () => {
                  // Show tab bar with marker name
                  const tabBar = document.getElementById('tab-bar');
                  tabBar.textContent = loc.name;
                  tabBar.style.display = 'block';
  
                  // Hide all isochrones except the current one
                  locations.forEach((otherLoc) => {
                      map.setLayoutProperty(
                          `isoLayer-${otherLoc.name}`,
                          'visibility',
                          otherLoc.name === loc.name ? 'visible' : 'none'
                      );
                  });
              });
  
              markerElement.addEventListener('mouseout', () => {
                  // Hide tab bar
                  document.getElementById('tab-bar').style.display = 'none';
  
                  // Show all isochrones
                  locations.forEach((otherLoc) => {
                      map.setLayoutProperty(`isoLayer-${otherLoc.name}`, 'visibility', 'visible');
                  });
              });
          }
      });
    </script>
  </body>
</html>
